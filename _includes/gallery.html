{% comment %}
Masonry Gallery Component
Usage: {% include gallery.html gallery="gallery-name" %}
Requires: Data file at _data/galleries/[gallery-name].yml
{% endcomment %}

{% assign gallery_data = site.data.galleries[include.gallery] %}
{% assign gallery_id = include.gallery | slugify %}

{% if gallery_data %}
<!-- Gallery Container -->
<div class="masonry-gallery" id="gallery-{{ gallery_id }}">
  {% if gallery_data.title %}
  <h3 class="gallery-title">{{ gallery_data.title }}</h3>
  {% endif %}

  <div class="masonry-grid">
    {% for image in gallery_data.images %}
      {% capture image_path %}{{ gallery_data.folder }}/{{ image.filename }}{% endcapture %}
      <div class="masonry-item">
        <img
          src="{{ image_path | relative_url }}"
          alt="{{ image.alt | escape }}"
          title="{{ image.caption | default: image.alt | escape }}"
          loading="lazy"
          data-index="{{ forloop.index0 }}"
        >
      </div>
    {% endfor %}
  </div>
</div>

<!-- Lightbox Modal -->
<div class="gallery-lightbox hidden" id="lightbox-{{ gallery_id }}">
  <div class="lightbox-window">
    <div class="title-bar">
      <div class="window-close lightbox-close" id="lightbox-close-{{ gallery_id }}"></div>
      <div class="title lightbox-counter" aria-live="polite"></div>
      <div class="title-spacer"></div>
    </div>
    <div class="lightbox-content">
      <div class="lightbox-image-container">
        <div class="lightbox-loading">Loading...</div>
        <img class="lightbox-image" src="" alt="">
      </div>
      <div class="lightbox-caption"></div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const galleryId = 'gallery-{{ gallery_id }}';
  const lightboxId = 'lightbox-{{ gallery_id }}';
  const gallery = document.getElementById(galleryId);
  const lightbox = document.getElementById(lightboxId);

  if (!gallery || !lightbox) return;

  // Parse image data from gallery
  const images = [
    {% for image in gallery_data.images %}
    {% capture image_path %}{{ gallery_data.folder }}/{{ image.filename }}{% endcapture %}
    {
      src: {{ image_path | relative_url | jsonify }},
      alt: {{ image.alt | jsonify }},
      caption: {{ image.caption | default: "" | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  // Exit if no images
  if (images.length === 0) return;

  let currentIndex = 0;

  // DOM elements
  const lightboxImage = lightbox.querySelector('.lightbox-image');
  const lightboxCaption = lightbox.querySelector('.lightbox-caption');
  const lightboxCounter = lightbox.querySelector('.lightbox-counter');
  const lightboxLoading = lightbox.querySelector('.lightbox-loading');
  const closeBtn = document.getElementById('lightbox-close-{{ gallery_id }}');

  // Initialize gallery
  function initGallery() {
    const items = gallery.querySelectorAll('.masonry-item');
    items.forEach((item) => {
      item.addEventListener('click', function(e) {
        // Disable lightbox on mobile (single column view)
        if (window.innerWidth <= 480) {
          return;
        }

        e.preventDefault();
        const img = this.querySelector('img');
        if (img) {
          const index = parseInt(img.getAttribute('data-index'));
          openLightbox(index);
        }
      });
    });
  }

  // Open lightbox at specific index
  function openLightbox(index) {
    currentIndex = index;
    updateLightbox();
    lightbox.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Focus management for accessibility
    closeBtn.focus();
  }

  // Close lightbox
  function closeLightbox() {
    lightbox.classList.add('hidden');
    document.body.style.overflow = '';
  }

  // Navigate (direction: 1 for next, -1 for prev)
  function navigate(direction) {
    currentIndex = (currentIndex + direction + images.length) % images.length;
    updateLightbox();
  }

  // Update lightbox content
  function updateLightbox() {
    const currentImage = images[currentIndex];

    // Show loading state
    lightboxLoading.classList.remove('hidden');
    lightboxImage.classList.add('hidden');

    // Update image
    lightboxImage.src = currentImage.src;
    lightboxImage.alt = currentImage.alt;

    // Update caption
    lightboxCaption.textContent = currentImage.caption || '';

    // Update counter
    lightboxCounter.textContent = `${currentIndex + 1} / ${images.length}`;

    // Handle image load
    lightboxImage.onload = function() {
      lightboxLoading.classList.add('hidden');
      lightboxImage.classList.remove('hidden');
    };

    lightboxImage.onerror = function() {
      lightboxLoading.textContent = 'Error loading image';
    };
  }

  // Event handlers
  closeBtn.addEventListener('click', closeLightbox);

  // Click overlay to close
  lightbox.addEventListener('click', function(e) {
    if (e.target === lightbox) {
      closeLightbox();
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (lightbox.classList.contains('hidden')) return;

    if (e.key === 'Escape') {
      closeLightbox();
    }
  });

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGallery);
  } else {
    initGallery();
  }
})();
</script>

{% else %}
<!-- Gallery data not found -->
<div class="error-message">
  Gallery "{{ include.gallery }}" not found. Please create _data/galleries/{{ include.gallery }}.yml
</div>
{% endif %}
